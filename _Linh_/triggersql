-- TRIGGER KIEM TRA VA TINH GIA VE
CREATE OR REPLACE TRIGGER KT_VE
BEFORE INSERT OR UPDATE
ON CHITIETVE
FOR EACH ROW

BEGIN
  IF ((SELECT VE.TINHTRANG FROM CHITIETVE TB JOIN VE ON CT.MAVE = VE.MAVE WHERE CT.MAVE = :NEW.MAVE) != 0)
  THEN
   BEGIN
      UPDATE CHITIETVE CT SET CT.GIA = UP_GIA(:NEW.MAVE) WHERE CT.MAVE = :NEW.MAVE;
      DBMS_OUTPUT.PUT('THANH CONG!');
    END;
  ELSE
    DBMS_OUTPUT.PUT('LOI: TINH TRANG=0 !');
    ROLLBACK;
  END IF;
END;



-- TRIGGER CAP NHAT SO LUONG GHE KHI THEM VE
CREATE OR REPLACE TRIGGER GHE_CB
AFTER INSERT 
ON VE
FOR EACH ROW
DECLARE 
  V_LOAIVE LOAIVE%TYPE;
BEGIN
  SELECT VE.LOAIVE 
  INTO V_LOAIVE
  FROM VE
  WHERE VE.MAVE = :NEW.MAVE;
  
  IF (V_LOAIVE = 1)
  THEN
  BEGIN
    IF ((SELECT CB.SOGHEVIPTRONG FROM CHUYENBAY CB, VE WHERE VE.MAVE=:NEW.MAVE AND VE.MACB=CB.MACB) > 0)
    THEN
      UPDATE CHUYENBAY CB 
      SET CB.SOGHEVIPTRONG = CB.SOGHEVIPTRONG - 1 
      WHERE VE.MAVE=:NEW.MAVE;
    ELSE
    BEGIN
      DBMS_OUTPUT.PUT('HET GHE !');
      ROLLBACK;   
    END;
    END IF;
    END;
    
    ELSIF ((SELECT VE.LOAIVE FROM VE WHERE VE.MAVE=:NEW.MAVE) = 0)
    THEN
    BEGIN
    IF ((SELECT CB.SOGHETHUONGTRONG FROM CHUYENBAY CB, VE WHERE VE.MAVE=:NEW.MAVE AND VE.MACB=CB.MACB) > 0)
    THEN
      UPDATE CHUYENBAY CB 
      SET CB.SOGHETHUONGTRONG = CB.SOGHEVIPTRONG - 1 
      WHERE VE.MAVE=:NEW.MAVE; 
    ELSE
    BEGIN
      DBMS_OUTPUT.PUT('HET GHE !');
      ROLLBACK;
    END;
    END IF;
  END;
  
  END IF;
  
END;



--TRIGGER: THOI GIAN BAY TOI THIEU LA 30P
CREATE OR REPLACE TRIGGER CK_TG_CB
AFTER INSERT
ON CHUYENBAY
FOR EACH ROW
DECLARE
  V_THOIGIANBAY THOIGIANBAY%TYPE;
BEGIN
  SELECT CB.THOIGIANBAY 
  INTO V_THOIGIANBAY
  FROM CHUYENBAY CB
  WHERE CB.MACB = :NEW.MACB;
    
  IF (V_THOIGIANBAY < 30)
  THEN
  BEGIN
    DBMS_OUTPUT.PUT ('LOI: THOI GIAN BAY TOI THIEU LA 30P');
    ROLLBACK;
  END;
  ELSE
    DBMS_OUTPUT.PUT ('THANH CONG!');
  END IF;
  
END;



--TRIGGER: KHACH HANG DAT VE PHAI TREN 18 TUOI
ALTER SESSION SET NLS_DATE_FORMAT = 'DD-MM-YYYY';
  
CREATE OR REPLACE TRIGGER CK_TUOI_KH
AFTER INSERT OR UPDATE
ON KHACHHANG
FOR EACH ROW
DECLARE
  V_TUOI INT;
BEGIN
  V_TUOI := 0;
  
  SELECT INT(TO_CHAR(SYSDATE, 'DD-MM-YYYY') - TO_CHAR(KH.NGAYSINH, 'DD-MM-YYYY'))
  INTO V_TUOI
  FROM KHACHHANG KH
  WHERE KH.MAKH = :NEW.MAKH;
  
  IF (V_TUOI < 18)
  THEN
  BEGIN
    DBMS_OUTPUT.PUT ('LOI: KHACH HANG DAT VE PHAI TREN 18 TUOI');
    ROLLBACK;
  END;
  ELSE
    DBMS_OUTPUT.PUT ('THANH CONG!');
  END IF;

END;



--TRIGGER: N?u khách hàng h?y vé thì c?p nh?t tình tr?ng gh?
CREATE OR REPLACE TRIGGER UD_GHE
AFTER UPDATE 
ON VE
FOR EACH ROW

BEGIN
  IF (:NEW.TINHTRANG = 0) 
  THEN
  BEGIN
    IF (:NEW.LOAIVE = 0)
    THEN
      UPDATE CHUYENBAY CB
      SET CB.SOGHETHUONGTRONG = CB.SOGHETHUONGTRONG + 1
      WHERE CB.MACB = :NEW.MACB;    
    ELSE
      UPDATE CHUYENBAY CB
      SET CB.SOGHEVIPTRONG = CB.SOGHEVIPTRONG + 1
      WHERE CB.MACB = :NEW.MACB;
    END IF; 
  END;
  END IF;
  
  DBMS_OUTPUT.PUT ('CAP NHAT THANH CONG!');
  
END;



--TRIGGER: CHUYEN BAY KHONG TRUNG NHAU
CREATE OR REPLACE TRIGGER CK_CB
AFTER INSERT
ON CHUYENBAY
FOR EACH ROW
DECLARE
  V_ROW CHUYENBAY%ROWTYPE;
  CURSOR CUR IS SELECT * FROM CHUYENBAY; 
BEGIN
  OPEN CUR;
  
  LOOP
    FETCH CUR INTO V_ROW;
    EXIT WHEN CUR%NOTFOUND;
    IF (CUR.MAHMB=:NEW.MAHMB AND CUR.DIEMKHOIHANH=:NEW.DIEMKHOIHANH AND CUR.DIEMDEN=:NEW.DIEMDEN AND CUR.SANBAYDI=:NEW.SANBAYDI AND CUR.SANBAYDEN=:NEW.SANBAYDEN AND CUR.THOIGIANKHOIHANH=:NEW.THOIGIANKHOIHANH AND CUR.THOIGIANBAY=:NEW.THOIGIANBAY)
    THEN
    BEGIN
      DBMS_OUTPUT.PUT ('CHUYEN BAY DA TON TAI!');
      ROLLBACK;
    END;
    ELSE
      DBMS_OUTPUT.PUT ('THEM THANH CONG!');
    END IF;
  END LOOP;
  
  CLOSE CUR;
  
END;

