-- STORED CAP NHAT BANG GIA
CREATE OR REPLACE PROCEDURE TINHTIEN
IS
  V_GIA CHITIETVE.GIA%TYPE;
  V_ROW CHITIETVE%ROWTYPE;
  CURSOR CUR IS SELECT * FROM CHITIETVE;
BEGIN
  OPEN CUR;
  
  LOOP
  FETCH CUR INTO V_ROW;
  EXIT WHEN CUR%NOTFOUND;
  SELECT CB.GIAVE * ((100 - KM.GIAMGIA) / 100) * (VE.TYLE / 100) 
  INTO V_GIA
  FROM CHITIETVE CT, VE, CHUYENBAY CB, KHUYENMAI KM 
  WHERE CT.MAVE=CUR.MAVE AND CT.MAVE=VE.MAVE AND VE.MACB=CB.MACB AND CT.MAKM=KM.MAKM; 
  UPDATE CHITIETVE CT SET CT.GIA = V_GIA WHERE CT.MAVE = CUR.MAVE;
  END LOOP;
  
  CLOSE CUR;
END;
